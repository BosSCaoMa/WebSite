# 用户角色管理系统

## 概述

本系统为现有的Web应用添加了基于角色的访问控制功能，支持普通用户和管理员两种角色。管理员用户可以访问专门的管理控制台，而普通用户则使用标准的用户界面。

## 功能特性

### 用户角色
- **普通用户** (role = 0): 访问标准的用户界面 (`main.html`)
- **管理员** (role = 1): 可以访问管理员控制台 (`admin.html`) 和所有管理功能

### 登录流程
1. 用户在登录页面 (`index.html`) 输入邮箱和密码
2. 系统验证用户身份并检查角色
3. 根据用户角色自动跳转：
   - 普通用户 → `main.html`
   - 管理员 → `admin.html`

### 管理员功能
- 用户管理：查看、添加、编辑、禁用用户
- 系统设置：配置系统参数
- 系统日志：查看错误日志和访问日志
- 安全管理：登录记录、IP黑名单
- 数据备份：创建和恢复数据备份

## 安装和配置

### 方式一：使用自动化脚本 (推荐)

#### Linux/Unix 系统:
```bash
# 给脚本添加执行权限
chmod +x init_role_system.sh

# 运行安装脚本
./init_role_system.sh
```

#### Windows 系统:
```batch
# 双击运行批处理文件
setup_role_system.bat
```

### 方式二：手动安装

#### 1. 修改数据库表结构
执行以下SQL语句为现有用户表添加角色字段：

```sql
-- 添加角色字段
ALTER TABLE sys_user ADD COLUMN role TINYINT DEFAULT 0 COMMENT '用户角色: 0=普通用户, 1=管理员';

-- 添加索引
CREATE INDEX idx_user_role ON sys_user(role);
CREATE INDEX idx_user_email_role ON sys_user(email, role);
```

#### 2. 创建管理员账户
```sql
-- 创建管理员账户 (请使用安全的密码哈希)
INSERT INTO sys_user (username, email, password_hash, role) 
VALUES ('admin', 'admin@example.com', 'your_secure_password_hash', 1);
```

#### 3. 更新后端代码
- 编译并部署更新后的后端代码
- 确保包含了角色验证逻辑

## 文件结构

```
project/
├── backEnd/
│   ├── include/
│   │   ├── MySQLProc.h          # 更新：添加了UserRole枚举和角色相关函数
│   │   └── logIn.h              # 更新：Session结构添加了角色信息
│   ├── MySQLProc.cpp            # 更新：添加了角色查询和处理逻辑
│   └── logIn.cpp                # 更新：登录时包含角色信息
├── web/
│   ├── index.html               # 更新：登录时根据角色跳转
│   ├── main.html                # 更新：管理员可见管理入口
│   └── admin.html               # 新增：管理员专用界面
├── database_role_init.sql       # 完整的数据库初始化脚本
├── upgrade_user_table.sql       # 简化的表结构升级脚本
├── init_role_system.sh          # Linux安装脚本
└── setup_role_system.bat        # Windows安装脚本
```

## 使用指南

### 管理员用户
1. 使用管理员账户登录系统
2. 自动跳转到管理员控制台 (`admin.html`)
3. 在控制台中可以进行各种管理操作
4. 也可以通过普通界面的"管理员控制台"链接进入

### 普通用户
1. 使用普通账户登录系统
2. 跳转到标准用户界面 (`main.html`)
3. 如果该用户同时也是管理员，会在侧边栏看到"管理员控制台"链接

## 安全注意事项

1. **密码安全**: 管理员密码必须足够复杂，建议使用强密码策略
2. **会话管理**: Token有效期为1小时，需要定期更新
3. **权限控制**: 前端和后端都应验证用户角色
4. **日志审计**: 系统会记录管理员操作日志用于安全审计

## 故障排除

### 常见问题

#### 1. 登录后无法跳转到管理员页面
- 检查用户角色字段是否正确设置为1
- 确认后端返回的角色信息是否正确
- 检查浏览器控制台是否有JavaScript错误

#### 2. 数据库连接失败
- 检查数据库配置信息是否正确
- 确认数据库服务是否正常运行
- 验证用户权限是否足够

#### 3. 管理员界面无法访问
- 确认`admin.html`文件是否存在于web目录
- 检查用户是否确实具有管理员权限
- 验证Token是否有效

### 调试技巧
1. 使用浏览器开发者工具查看网络请求和响应
2. 检查localStorage中的认证信息
3. 查看数据库中的用户角色数据
4. 检查后端日志文件

## 扩展功能

系统已预留了扩展接口，可以轻松添加：
- 更多用户角色（如版主、编辑等）
- 细粒度权限控制
- 操作审计日志
- 多级管理员权限

## 技术支持

如遇到问题，请检查：
1. 数据库表结构是否正确创建
2. 后端代码是否正确编译和部署
3. 前端文件是否正确放置
4. 网络和服务器配置是否正常
