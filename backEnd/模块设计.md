# 函数流程

## 1. 网络连接与请求解析模块（ConnectProc）
- 负责监听端口，接收客户端连接。
- 解析 HTTP 请求，提取 method、path、headers、body、token。
- 多线程处理每个连接，自动关闭无效或异常连接。
- 路由分发：根据请求类型和路径调用对应业务处理函数。

**关键代码：**
```cpp
struct HttpRequest {
    std::string method, path, version, body, token;
    std::unordered_map<std::string, std::string> headers;
};
void handle_client(int client_fd); // 线程入口
bool parse_http_request(const std::string& raw, HttpRequest& req);
```

## 2. 用户认证与会话管理模块（logIn）
- 登录接口：校验邮箱和密码，生成 token，存储会话。
- 登出接口：删除会话。
- token 验证：校验 token 有效性和过期时间。
- 会话审计线程：定期清理过期会话，提升安全性。

**关键代码：**
```cpp
struct Session {
    std::string token, email;
    std::chrono::steady_clock::time_point expireAt;
    UserRole role;
};
extern std::unordered_map<std::string, Session> g_sessionStore;
extern std::mutex g_sessionMutex;
void handleLogInRequest(const std::string& body, std::function<void(int, const std::string&)> sendResponse);
bool validateToken(const std::string& token, std::string* emailOut = nullptr, UserRole* roleOut = nullptr);
void startSessionAuditThread(int intervalSeconds = 60);
```

## 3. 注册与业务处理模块（signUp、business）
- 注册接口：处理新用户注册。
- 业务接口：如 /api/business，需校验 token。

**关键代码：**
```cpp
void handleSignUpRequest(const std::string& body, std::function<void(int, const std::string&)> sendResponse);
void handleBusinessRequest(const std::string& token, std::function<void(int, const std::string&)> sendResponse);
```

## 4. 数据库操作模块（MySQLProc）
- 用户信息查询、角色管理等。
- 底层与数据库交互，提供数据支持。

**关键代码：**
```cpp
struct UserInfo {
    std::string email, passwordHash;
    UserRole role;
};
UserInfo QueryUserInfoByEmail(const std::string& email);
```

## 5. 日志模块（LogM）
- 统一日志输出，支持调试和运维。

**关键代码：**
```cpp
#define LOG_INFO(fmt, ...) // ...
#define LOG_ERROR(fmt, ...) // ...
#define LOG_DEBUG(fmt, ...) // ...
```

## 6. 公共数据结构与工具
- HttpRequest、Session、UserInfo 等结构体。
- 工具函数如 base64 编码、密码校验等。

**关键代码：**
```cpp
bool verifyPassword(const std::string& inputPassword, const std::string& storedHash);
std::string base64Encode(const std::string& in);
```

---
各模块之间通过接口和数据结构协作，保证系统安全、可扩展和易维护。
典型流程：
1. 客户端发起 HTTP 请求，ConnectProc 解析并分发。
2. 登录/注册/业务等接口由对应模块处理，必要时访问数据库。
3. 会话管理模块负责 token 校验和过期清理。
4. 日志模块记录关键操作和异常。



